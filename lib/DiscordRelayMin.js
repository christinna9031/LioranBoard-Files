const DiscTwitchRelay={settings:void 0,socket:void 0,heartbeat:5e3,session_id:void 0,seq:void 0,callbacks:{},next_callbacks:{},emit:function(t,e){null!=this.callbacks[t]&&this.callbacks[t].forEach(function(t){t(e)}),null!=this.next_callbacks[t]&&(this.next_callbacks[t].forEach(function(t){t(e)}),delete this.next_callbacks[t])},on:function(t,e){null==this.callbacks[t]&&(this.callbacks[t]=[]),this.callbacks[t].push(e)},next:function(t,e){null==this.next_callbacks[t]&&(this.next_callbacks[t]=[]),this.next_callbacks[t].push(e)},gateway:void 0,calls:{},chunks:function*(t,e){for(let s=0;s<t.length;s+=e)yield t.slice(s,s+e)},LBAlert:function(t){lioranboardclient.send('{"type":"MESSAGE","topic":"AlertMessage","message":"'+t+'"}')},fetchDiscordRelay:async function(t,e,s){let i={method:e,headers:{"Content-Type":"application/json"}};s&&(i.body=JSON.stringify(s));const o=await fetch(t,i);let c;if(!o.ok){let t=await o.json(),e=t.message||t.error||"Something went wrong.";throw new Error(e)}try{c=await o.json()}catch(t){}return c},Chatters:async t=>{let e=sessionStorage.getItem("chatters")||[];await fetch("https://lioranboard-proxy.herokuapp.com/https://tmi.twitch.tv/group/user/dashducks/chatters").then(t=>t.json()).then(t=>{const{broadcaster:s,moderators:i,viewers:o,vips:c}=t.chatters;let a=[...i,...o,...c];try{a.push(s[0])}catch(t){}let n=e;e=[],a.forEach(function(t){n.includes(t)||e.push(t)}),sessionStorage.setItem("chatters",n.concat(","+a))}).catch(t=>{}),[...DiscTwitchRelay.chunks(e,100)].forEach(async function(t){let e=t.join("&login=");await fetch("https://api.twitch.tv/helix/users?login="+e,{headers:{"Client-ID":TWITCH_CLIENT_ID,Authorization:"Bearer "+DiscTwitchRelay.settings.oauthtoken,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{t.data.forEach(function(t){let e=t.profile_image_url||t.offline_image_url;sessionStorage.setItem(t.login+"_url",e)})}).catch(t=>console.log(t))}),TWCRelay.timeout=setTimeout(DiscTwitchRelay.Chatters,6e4,"dashducks")},TwitchWebhook:function(){let t=this.settings;if(0!=t.array.length){let e=t.array;this.settings.array=[];let s=[],i=" ";if("pretty"==t.mode&&e.length<11)for(let t=0;t<e.length;t++){let i=e[t].user_type+" "||"",o=sessionStorage.getItem(e[t].username.toLowerCase()+"_url")||"https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png";s.push({author:{name:i+e[t].username,url:"https://twitch.tv/"+e[t].username,icon_url:o},description:e[t].text,color:this.convertColor(e[t].color)})}else for(let t=0;t<e.length;t++)i=i+"\n\n**"+e[t].username+"**\n"+e[t].text,s=void 0;let o={content:i,username:"Twitch Chat"};s&&(o.embeds=s),DiscTwitchRelay.fetchDiscordRelay(t.webhook,"POST",o).catch(t=>DiscTwitchRelay.LBAlert("Discord Relay webhook error:"+t))}},convertColor:function(t){let e,s,i=[];if(-1!=t.search("#")&&(t=t.substr(1)),3===t.length)for(e=t.split(""),s=0;s<3;s++)i.push(parseInt(e[s]+""+e[s],16));else if(6===t.length)for(e=t.match(/.{2}/g),s=0;s<3;s++)i.push(parseInt(e[s],16));i[2],i[1],i[0];return i[2]+(i[1]<<8)+(i[0]<<16)},connect:async function(t=!1){let e=this.settings,s="wss://gateway.discord.gg";await DiscTwitchRelay.fetchDiscordRelay("https://discord.com/api/gateway","GET").then(t=>s=t.url+"?v=8&encoding=json").catch(t=>{s="wss://gateway.discord.gg?v=8&encoding=json"});var i=this;this.gateway=s,this.socket=new WebSocket(s),this.socket.onopen=function(t){DiscTwitchRelay.emit("open","Connection established!")},this.socket.onmessage=function(s){if(data=s.data,"string"==typeof s.data&&(data=JSON.parse(s.data),null!=data.s&&(i.seq=data.s)),"READY"==data.t&&(DiscTwitchRelay.emit("DiscordSuccess",s),t?i.socket.send(JSON.stringify({op:6,d:{token:e.token,session_id:i.session_id,seq:i.seq}})):i.session_id=data.d.session_id,this.reconnecting?(this.reconnecting=!1,i.emit("reconnected")):i.emit("ready")),null!=data.op&&10==data.op?(i.heartbeat=data.d.heartbeat_interval,i.ping=setInterval(function(){null!=i.socket&&i.socket.send(JSON.stringify({op:1,d:null}))},i.heartbeat),i.socket.send(JSON.stringify({op:2,d:{token:e.token,intents:512,large_threshold:100,properties:{os:e.os||"windows",browser:e.device||"LBTwitch",device:e.device||"LBTwitch",referrer:"",referring_domain:""}}}))):data.op,0==data.op){var o=data.t,c=data.d;i.emit(o,c),"MESSAGE_CREATE"==o?DiscTwitchRelay.emit("message",c):"GUILD_MEMBER_REMOVE"==o?DiscTwitchRelay.emit("member_remove",c):"GUILD_MEMBER_ADD"==o?DiscTwitchRelay.emit("member_add",c):"MESSAGE_UPDATE"==o&&DiscTwitchRelay.emit("edited",c)}7==data.op&&i.close(!0,!0),9==data.op&&i.close(!0,!1),data.op},this.socket.onerror=function(t){i.socket.readyState==i.socket.CLOSED&&setTimeout(i.close,5e3,!0),DiscTwitchRelay.emit("socketError",t)},this.socket.onclose=function(t){4004!==t.code&&setTimeout(i.close,5e3,!0),DiscTwitchRelay.emit("socketClosedError",t.reason)}},reconnecting:!1,close:function(t,e=!1){const s=DiscTwitchRelay;try{clearInterval(s.socket.ping)}catch(t){}s.socket.onclose=void 0,s.socket.onerror=void 0,s.socket.close(),s.socket=void 0,e||(s.session_id=void 0),t?(s.reconnecting=!0,s.connect(e)):(s.callbacks={},s.next_callbacks={},s.gateway=void 0),DiscTwitchRelay.emit("closed")},send:function(t){this.socket.send(JSON.stringify(t))}};