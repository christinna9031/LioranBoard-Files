const urlParams=new URLSearchParams(window.location.search),port=urlParams.get("port")||4444,pw=urlParams.get("pw")||"",ns="http://www.w3.org/2000/svg",makeSvgNode=(e,t)=>t.createElementNS(ns,e),wheel=document.querySelector(".wheel"),segments=document.querySelector("#segments"),sticks=document.querySelector("#sticks"),labels=document.querySelector("#labels"),defs=document.querySelector("#defs"),circleImages=document.querySelector("#circleImages"),winners=document.querySelector(".winner"),ul=document.querySelector(".labels"),log=document.querySelector("#log"),strokeSegmentC="#ECECEC",strokeSegmentW="4",dX=365,dY=365,markerAngle=30,colorPalette=["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#00AEFF","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#607d8b"];let obs,obswsTimeout,arr,colors,images,userImage=!1,userColor=!1,anim="default",currentColors=[];const currentImages=[],fullSpins=7;let requestStop,stopAtPrevious=0,subAngle=0,loopIteration=0;function StartListening(){(obs=new OBSWebSocket).connect({address:`localhost:${port}`,password:pw}).catch(e=>{ChangeStatus(`Error: ${e.error}. Edit SETUP button in your premade deck in LB and press it. `),obs.disconnect()}),obs.on("AuthenticationSuccess",()=>{console.log("Fortune Wheel: Listening for traffic."),log.innerHTML=""}),obs.on("BroadcastCustomMessage",e=>{log.innerHTML="","Lucky Wheel Populate"===e.realm?(drawWheel(e.data),window.startScrolling&&(window.startScrolling.kill(),window.startScrolling=void 0),gsap.set(".labels",{y:0}),scrollLabels()):"Lucky Wheel Modify"===e.realm?drawWheel(e.data,!0):"Lucky Wheel Check"===e.realm?obs.send("BroadcastCustomMessage",{realm:"Lucky Wheel Ready",data:{}}):"Lucky Wheel Spin"===e.realm?wheelSpin():"Lucky Wheel Stop"===e.realm&&(requestStop=!0)}),obs.on("ConnectionClosed",()=>{console.log("Connection closed. Attempting to reconnect in 10s.");try{clearTimeout(obswsTimeout)}catch(e){}obs.removeAllListeners(),obswsTimeout=setTimeout(()=>{StartListening()},1e4)}),obs.on("error",e=>{ChangeStatus(`Error: ${e}`),obs.disconnect()})}function drawWheel(e,t=!1){arr=[],anim=t?anim:e.animation||"default",userColor=t?userColor:!!e.colors[0],userImage=t?userImage:!!e.images[0],t||(currentColors=[]),getRandomColor(colorPalette),segments.innerHTML="",labels.innerHTML="",ul.innerHTML="",document.querySelector("#images").innerHTML="",circleImages.innerHTML="",winners.innerHTML="",sticks.innerHTML="",delete e.rewards.name,delete e.rewards.size,delete e.weights.name,delete e.weights.size,t||(e.colors[0]&&delete e.colors.name,delete e.colors.size,e.images[0]&&delete e.images.name,delete e.images.size);const r=Object.values(e.rewards),n=Object.values(e.weights);if(colors=t?colors:Object.values(e.colors),images=t?images:Object.values(e.images),r.forEach((e,t)=>{arr[t]={text:e,weight:n[t],image:images[t],color:colors[t]}}),arr.forEach((e,t)=>{let r=toDegrees(e.weight);arr[t].simpleAngle=r,0!==t&&(r=arr[t-1].angle+r),arr[t].angle=r}),(arr=arr.reverse()).forEach((e,r)=>{const{angle:n}=e,o=toRadians(n),a=r<arr.length-1?arr[r+1].angle:arr[0].angle,s=toRadians(a),i=(n+(r<arr.length-1?a:0))/2,l=toRadians(i),c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttribute("id",`reward_${r}`),createSegment(e.weight,o,s,r,c,t),createStick(o,c,r),userImage?createImage(l,o,e.weight,e.image,r):addSegmentText(i,e.text,r,e.weight,c),createLabel(e.text,e.weight,r),segments.appendChild(c)}),userImage){const e=defs.innerHTML;defs.innerHTML="",defs.innerHTML=e}}function createImage(e,t,r,n,o){const a=dX+225*Math.cos(e),s=dY+225*Math.sin(e),i=dX+225*Math.cos(t),l=dY+225*Math.sin(t),c=Math.sqrt((a-i)**2+(s-l)**2),d=.7*c>80?80:.7*c,u=document.createElementNS("http://www.w3.org/2000/svg","pattern"),m=document.createElementNS("http://www.w3.org/2000/svg","image"),g=document.createElementNS("http://www.w3.org/2000/svg","circle"),p=90+180*e/Math.PI;arr[o].rotation=p,u.setAttribute("id",`pattern_${o}`),u.setAttribute("height","100%"),u.setAttribute("width","100%"),u.setAttribute("patternContentUnits","objectBoundingBox"),m.setAttribute("id",`img_${o}`),m.setAttribute("xlink:href",`img/${n}`),m.setAttribute("preserveAspectRatio","none"),m.setAttribute("width","1"),m.setAttribute("height","1"),g.setAttribute("id",`circle_${o}`),g.setAttribute("cx",a),g.setAttribute("cy",s),g.setAttribute("r",d),g.setAttribute("style",`fill: url(#pattern_${o})`),u.appendChild(m),document.querySelector("#images").appendChild(u),circleImages.appendChild(g),gsap.set(m,{transformOrigin:"50% 50%",rotate:90+180*e/Math.PI})}function createSegment(e,t,r,n,o,a=!1){const s=326*Math.cos(t),i=326*Math.sin(t),l=365+326*Math.cos(r),c=365+326*Math.sin(r),d=e>50?1:0,u=document.createElementNS("http://www.w3.org/2000/svg","path");let m;a?m=currentColors[n]:(m=userColor?arr[n].color:getColor(n),currentColors.push(m)),u.setAttribute("d",`M${dX},${dY},l${s},${i} A 326 326 0 ${d} 0 ${l} ${c} Z`),u.setAttribute("fill",m),u.setAttribute("stroke",strokeSegmentC),u.setAttribute("stroke-width",strokeSegmentW),u.setAttribute("transform","translate(0)"),u.setAttribute("id",`segment_${n}`),o.appendChild(u)}function createStick(e,t,r){const n=349*Math.cos(e-.02),o=349*Math.sin(e-.02),a=349*Math.cos(e+.02),s=349*Math.sin(e+.02),i=360*Math.cos(e+.02),l=360*Math.sin(e+.02),c=360*Math.cos(e-.02),d=360*Math.sin(e-.02),u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M${365+n},${365+o}, A 1 1 0 0 0 ${365+a} ${365+s} L ${365+i} ${365+l} A 1 1 0 0 0 ${365+c} ${365+d} Z`),u.setAttribute("fill","#fff"),u.setAttribute("id",`spike_${r}`),u.setAttribute("transform","translate(0)"),sticks.appendChild(u)}function addSegmentText(e,t,r,n,o){const a=document.createElementNS("http://www.w3.org/2000/svg","text"),s=new svgTextSize(t,{"font-size":35,"font-family":"Raleway:800"}),i=180/s.width*35,l=3.6*n*1.6/s.height*35,c=i>l?l:i,d=80+(190-new svgTextSize(t,{"font-size":c,"font-family":"Raleway:800"}).width)/2;gsap.set(a,{x:365,y:365,rotate:e}),a.setAttribute("class","text"),a.innerHTML=`<tspan id="text_${r}" alignment-baseline="central" text-shadow="0.05em 0 black,0 0.05em black,-0.05em 0 black,0 -0.05em black, -0.05em -0.05em black, -0.05em 0.05em black, 0.05em -0.05em black, 0.05em 0.05em black" text-align="center" dx="${d}" dy="0" font-family="Raleway" font-weight="bold" fill="white" font-size="${c}" >${t}</tspan>`,o.appendChild(a)}function createLabel(e,t,r){const n=`${Math.round(t)}%`,o=document.createElement("li"),a=document.createElement("div"),s=document.createElement("div"),i=currentColors[r];o.setAttribute("style",`background: linear-gradient(to right, ${i} 12%, rgba(0, 0, 0, 0.7) 15%)`),o.setAttribute("class","item"),s.setAttribute("class","item-weight"),a.setAttribute("class","item-title"),s.innerHTML=n,a.innerHTML=e,o.appendChild(a),o.appendChild(s),ul.appendChild(o)}function scrollLabels(){const e=gsap.getProperty(".labels","height");e<740||(gsap.set(".labels",{y:0}),window.startScrolling=new gsap.timeline({repeat:-1,repeatDelay:10,repeatRefresh:!0,ease:"power1.inOut",onRepeat:()=>{0-gsap.getProperty(".labels","y")>=e&&(gsap.set(".labels",{y:744}),gsap.to(".labels",{y:0,duration:3,ease:"power1.inOut",delay:1}))}}),window.startScrolling.to(".labels",{y:"-=744",duration:3,ease:Power3.easeIn,delay:10}),window.startScrolling.play())}function makeTextSpanNode(e,t){const r=t.createTextNode(e),n=makeSvgNode("tspan",t);return n.setAttribute("x",0),n.setAttribute("y",0),n.appendChild(r),n}function makeTextNode(e,t={},r){const n=makeSvgNode("text",r);n.setAttribute("x",0),n.setAttribute("y",0);for(const e in t)n.setAttribute(e,t[e]);return n.appendChild(makeTextSpanNode(e,r)),n}function svgTextSize(e,t){const r=document,n=makeSvgNode("svg",r),o=makeTextNode(e,t,r);n.appendChild(o),r.body.appendChild(n);const{width:a,height:s}=o.getBBox();return r.body.removeChild(n),{width:a,height:s}}function getRandomColor(){const e=Math.floor(Math.random()*colorPalette.length),t=colorPalette[e];colorPalette.remove(t),window.getColor=function(r){return 0==r?t:colorPalette[Math.floor(e+4*r)%colorPalette.length]}}function toRadians(e){return e*(Math.PI/180)}function toDegrees(e){return e/100*360}function wheelSpin(){const e=getRandomInt(0,360),t=1440+e+Math.abs(subAngle);let r,n;stopAtPrevious=e,requestStop=!1;let o=0,a=0,s=e+markerAngle;s>360&&(s-=360);do{o+=arr[a].simpleAngle,r=arr[a].text,n=a,a+=1}while(o<s);subAngle=360-stopAtPrevious,console.log("winner",r);const i=gsap.to(wheel,{rotation:"+=360",duration:1.5,transformOrigin:"50% 50%",ease:Power3.easeIn,onComplete:()=>l.play(),paused:!0}),l=gsap.to(wheel,{transformOrigin:"50% 50%",rotation:"+=360",ease:"none",duration:.35,onComplete:()=>{loopIteration>=fullSpins&&requestStop?c.play():(loopIteration++,l.play(0))},paused:!0}),c=gsap.to(wheel,{rotation:`+=${t}`,ease:Power3.easeOut,duration:t/360,paused:!0,onComplete:()=>(function(){"blink"!=anim||userImage?"mid"==anim&&userImage?winnerAnimImg(n,e):winnerAnimDefault(r):winnerAnimText(n,e);obs.send("BroadcastCustomMessage",{realm:"Lucky Wheel Win",data:{winner:r}}),i.kill(),l.kill(),c.kill()})()}),d=[];arr.forEach(e=>d.push(e.angle)),i.play()}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function winnerAnimDefault(e){const t=document.querySelector("#result");t.innerHTML=e,t.style.display="",t.classList.add("play"),setTimeout(()=>{t.classList.remove("play"),t.style.display="none"},5e3)}function winnerAnimText(e){const t=document.getElementById(`text_${e}`),r=gsap.timeline({repeat:2});r.to(t,{duration:.35,opacity:0}),r.to(t,{duration:.35,opacity:1}),r.play()}function winnerAnimImg(e,t){const r=document.getElementById(`circle_${e}`),n=(document.getElementById(`img_${e}`),t<180?-t:360-t<0?720-t:360-t),o=arr[e].rotation,a=-o+n<-360?360+(-o+n):-o+n,s=(r.cx.baseVal.value,r.cy.baseVal.value,gsap.timeline({repeat:1,repeatDelay:2,yoyo:!0})),i=200/r.r.baseVal.value;s.to(r,{duration:1,transformOrigin:"50% 50%",duration:1,attr:{cx:365,cy:365}}),s.to(r,{duration:1,scale:i,transformOrigin:"50% 50%",rotate:a}),s.play(),winners.append(r)}function ChangeStatus(e){console.log(e),log.innerHTML=e}document.addEventListener("DOMContentLoaded",()=>StartListening()),Array.prototype.remove=function(e){return this.some((t,r,n)=>t===e&&(n.splice(r,1),!0)),this};