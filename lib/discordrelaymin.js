const DiscTwitchRelay={settings:void 0,socket:void 0,heartbeat:5e3,session_id:void 0,seq:void 0,callbacks:{},next_callbacks:{},emit:function(e,t){null!=this.callbacks[e]&&this.callbacks[e].forEach(function(e){e(t)}),null!=this.next_callbacks[e]&&(this.next_callbacks[e].forEach(function(e){e(t)}),delete this.next_callbacks[e])},on:function(e,t){null==this.callbacks[e]&&(this.callbacks[e]=[]),this.callbacks[e].push(t)},next:function(e,t){null==this.next_callbacks[e]&&(this.next_callbacks[e]=[]),this.next_callbacks[e].push(t)},gateway:void 0,calls:{},chunks:function*(e,t){for(let n=0;n<e.length;n+=t)yield e.slice(n,n+t)},LBAlert:function(e){lioranboardclient.send('{"type":"MESSAGE","topic":"AlertMessage","message":"'+e+'"}')},fetchDiscordRelay:async function(e,t,n){let o={method:t,headers:{"Content-Type":"application/json"}};n&&(o.body=JSON.stringify(n));const s=await fetch(e,o);let i;if(!s.ok){let e=await s.json(),t=e.message||e.error||"Something went wrong.";throw new Error(t)}try{i=await s.json()}catch(e){}return i},Chatters:async e=>{let t=JSON.parse(sessionStorage.getItem("chatters"))||[];await fetch("https://lioranboard-proxy.herokuapp.com/https://tmi.twitch.tv/group/user/"+e+"/chatters").then(e=>e.json()).then(e=>{const{broadcaster:n,moderators:o,viewers:s,vips:i}=e.chatters;let c=[...o,...s,...i];if(0==c.length)return void DiscTwitchRelay.LBAlert("Discord Relay error: Wrong channel name. No chatters found.");n[0]&&c.push(n[0]);let a=t;t=[],c.forEach(function(e){a.includes(e)||t.push(e)}),Array.prototype.unique=function(){for(var e=this.concat(),t=0;t<e.length;++t)for(var n=t+1;n<e.length;++n)e[t]===e[n]&&e.splice(n--,1);return e},sessionStorage.setItem("chatters",JSON.stringify(c.concat(a).unique()))}).catch(e=>{console.log(e)}),[...DiscTwitchRelay.chunks(t,100)].forEach(async function(e){let t=e.join("&login=");await fetch("https://api.twitch.tv/helix/users?login="+t,{headers:{"Client-ID":TWITCH_CLIENT_ID,Authorization:"Bearer "+DiscTwitchRelay.settings.oauthtoken,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.data.forEach(function(e){let t=e.profile_image_url||e.offline_image_url;sessionStorage.setItem(e.login+"_url",t)})}).catch(e=>console.log(e))}),TWCRelay.timeout=setTimeout(DiscTwitchRelay.Chatters,6e4,e)},TwitchWebhook:function(){let e=this.settings;if(0!=e.array.length){let t=e.array;this.settings.array=[];let n=[],o=" ";if("pretty"==e.mode&&t.length<11)for(let e=0;e<t.length;e++){let o=t[e].user_type+" "||"",s=sessionStorage.getItem(t[e].username.toLowerCase()+"_url")||"https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png";n.push({author:{name:o+t[e].username,url:"https://twitch.tv/"+t[e].username,icon_url:s},description:t[e].text,color:this.convertColor(t[e].color)})}else for(let e=0;e<t.length;e++)o=o+"_ _ \n**"+t[e].username+"**\n"+t[e].text,n=void 0;let s={content:o,username:"Twitch Chat"};n&&(s.embeds=n),DiscTwitchRelay.fetchDiscordRelay(e.webhook,"POST",s).catch(e=>DiscTwitchRelay.LBAlert("Discord Relay webhook: "+e))}},convertColor:function(e){let t,n,o=[];if(-1!=e.search("#")&&(e=e.substr(1)),3===e.length)for(t=e.split(""),n=0;n<3;n++)o.push(parseInt(t[n]+""+t[n],16));else if(6===e.length)for(t=e.match(/.{2}/g),n=0;n<3;n++)o.push(parseInt(t[n],16));o[2],o[1],o[0];return o[2]+(o[1]<<8)+(o[0]<<16)},connect:async function(e){let t=this.settings,n="wss://gateway.discord.gg?v=8&encoding=json";const o=this;await fetch("https://discord.com/api/gateway","GET").then(e=>n=e.url+"?v=8&encoding=json").catch(e=>{});try{clearInterval(o.ping)}catch(e){}o.gateway=n,o.socket=new WebSocket(n),o.socket.onopen=function(e){o.emit("open","Connection established!")},o.socket.onmessage=function(n){let s=n.data;if("string"==typeof n.data&&(s=JSON.parse(n.data)),"READY"==s.t&&(o.emit("DiscordSuccess",n),o.session_id=s.d.session_id,o.reconnecting?(o.reconnecting=!1,o.emit("reconnected")):o.emit("ready")),null!=s.s&&(o.seq=s.s),null!=s.op&&10==s.op?(o.heartbeat=s.d.heartbeat_interval,o.ping=setInterval(function(){null!=o.socket&&1===o.socket.readyState?o.socket.send(JSON.stringify({op:1,d:null})):clearInterval(o.ping)},o.heartbeat),e?o.socket.send(JSON.stringify({op:6,d:{token:o.settings.token,session_id:o.session_id,seq:o.seq}})):o.socket.send(JSON.stringify({op:2,d:{token:t.token,intents:512,large_threshold:100,properties:{os:t.os||"windows",browser:t.device||"LBTwitch",device:t.device||"LBTwitch",referrer:"",referring_domain:""}}}))):s.op,0==s.op){var i=s.t,c=s.d;o.emit(i,c),"MESSAGE_CREATE"==i?o.emit("message",c):"GUILD_MEMBER_REMOVE"==i?o.emit("member_remove",c):"GUILD_MEMBER_ADD"==i?o.emit("member_add",c):"MESSAGE_UPDATE"==i&&o.emit("edited",c)}7==s.op&&o.close(!0,!0),9==s.op&&o.close(!0),s.op},o.socket.onerror=function(e){o.socket.readyState==o.socket.CLOSED&&o.close(!0),o.emit("socketError",e.reason)},o.socket.onclose=function(e){4004!==e.code&&o.close(!0),o.emit("socketClosedError",e.reason)}},reconnecting:!1,close:function(e,t){const n=this;n.timeoutconnect&&clearTimeout(n.timeoutconnect),n.ping&&clearInterval(n.ping),n.socket.onclose=void 0,n.socket.onerror=void 0,n.socket=void 0,e&&(n.timeoutconnect=setTimeout(()=>{n.connect(t)},3e3)),n.emit("closed")},send:function(e){p.socket.send(JSON.stringify(e))}};