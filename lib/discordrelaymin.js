const DiscTwitchRelay={settings:void 0,socket:void 0,heartbeat:5e3,session_id:void 0,seq:void 0,callbacks:{},next_callbacks:{},emit:function(e,t){null!=this.callbacks[e]&&this.callbacks[e].forEach(function(e){e(t)}),null!=this.next_callbacks[e]&&(this.next_callbacks[e].forEach(function(e){e(t)}),delete this.next_callbacks[e])},on:function(e,t){null==this.callbacks[e]&&(this.callbacks[e]=[]),this.callbacks[e].push(t)},next:function(e,t){null==this.next_callbacks[e]&&(this.next_callbacks[e]=[]),this.next_callbacks[e].push(t)},gateway:void 0,calls:{},chunks:function*(e,t){for(let s=0;s<e.length;s+=t)yield e.slice(s,s+t)},LBAlert:function(e){lioranboardclient.send('{"type":"MESSAGE","topic":"AlertMessage","message":"'+e+'"}')},fetchDiscordRelay:async function(e,t,s){let o={method:t,headers:{"Content-Type":"application/json"}};s&&(o.body=JSON.stringify(s));const n=await fetch(e,o);let c;if(!n.ok){let e=await n.json(),t=e.message||e.error||"Something went wrong.";throw new Error(t)}try{c=await n.json()}catch(e){}return c},Chatters:async e=>{let t=JSON.parse(sessionStorage.getItem("chatters"))||[];if(await fetch("https://lioranboard-proxy.herokuapp.com/https://tmi.twitch.tv/group/user/"+e+"/chatters").then(e=>e.json()).then(e=>{const{broadcaster:s,moderators:o,viewers:n,vips:c}=e.chatters;let i=[...o,...n,...c];s[0]&&i.push(s[0]);let a=t;t=[],i.forEach(function(e){a.includes(e)||t.push(e)}),sessionStorage.setItem("chatters",JSON.stringify(a.concat(","+i)))}).catch(e=>{console.log(e)}),null==t[0])return void DiscTwitchRelay.LBAlert("Discord Relay error: Wrong channel name. No chatters found.");[...DiscTwitchRelay.chunks(t,100)].forEach(async function(e){let t=e.join("&login=");await fetch("https://api.twitch.tv/helix/users?login="+t,{headers:{"Client-ID":TWITCH_CLIENT_ID,Authorization:"Bearer "+DiscTwitchRelay.settings.oauthtoken,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.data.forEach(function(e){let t=e.profile_image_url||e.offline_image_url;sessionStorage.setItem(e.login+"_url",t)})}).catch(e=>console.log(e))}),TWCRelay.timeout=setTimeout(DiscTwitchRelay.Chatters,6e4,e)},TwitchWebhook:function(){let e=this.settings;if(0!=e.array.length){let t=e.array;this.settings.array=[];let s=[],o=" ";if("pretty"==e.mode&&t.length<11)for(let e=0;e<t.length;e++){let o=t[e].user_type+" "||"",n=sessionStorage.getItem(t[e].username.toLowerCase()+"_url")||"https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png";s.push({author:{name:o+t[e].username,url:"https://twitch.tv/"+t[e].username,icon_url:n},description:t[e].text,color:this.convertColor(t[e].color)})}else for(let e=0;e<t.length;e++)o=o+"_ _ \n**"+t[e].username+"**\n"+t[e].text,s=void 0;let n={content:o,username:"Twitch Chat"};s&&(n.embeds=s),DiscTwitchRelay.fetchDiscordRelay(e.webhook,"POST",n).catch(e=>DiscTwitchRelay.LBAlert("Discord Relay webhook: "+e))}},convertColor:function(e){let t,s,o=[];if(-1!=e.search("#")&&(e=e.substr(1)),3===e.length)for(t=e.split(""),s=0;s<3;s++)o.push(parseInt(t[s]+""+t[s],16));else if(6===e.length)for(t=e.match(/.{2}/g),s=0;s<3;s++)o.push(parseInt(t[s],16));o[2],o[1],o[0];return o[2]+(o[1]<<8)+(o[0]<<16)},connect:async function(e){let t=this.settings,s="wss://gateway.discord.gg?v=8&encoding=json";const o=this;await fetch("https://discord.com/api/gateway","GET").then(e=>s=e.url+"?v=8&encoding=json").catch(e=>{});try{clearInterval(o.ping)}catch(e){}o.gateway=s,o.socket=new WebSocket(s),o.socket.onopen=function(e){o.emit("open","Connection established!")},o.socket.onmessage=function(s){let n=s.data;if("string"==typeof s.data&&(n=JSON.parse(s.data)),"READY"==n.t&&(o.emit("DiscordSuccess",s),o.session_id=n.d.session_id,o.reconnecting?(o.reconnecting=!1,o.emit("reconnected")):o.emit("ready")),null!=n.s&&(o.seq=n.s),null!=n.op&&10==n.op?(o.heartbeat=n.d.heartbeat_interval,o.ping=setInterval(function(){null!=o.socket&&1===o.socket.readyState?o.socket.send(JSON.stringify({op:1,d:null})):clearInterval(o.ping)},o.heartbeat),e?o.socket.send(JSON.stringify({op:6,d:{token:o.settings.token,session_id:o.session_id,seq:o.seq}})):o.socket.send(JSON.stringify({op:2,d:{token:t.token,intents:512,large_threshold:100,properties:{os:t.os||"windows",browser:t.device||"LBTwitch",device:t.device||"LBTwitch",referrer:"",referring_domain:""}}}))):n.op,0==n.op){var c=n.t,i=n.d;o.emit(c,i),"MESSAGE_CREATE"==c?o.emit("message",i):"GUILD_MEMBER_REMOVE"==c?o.emit("member_remove",i):"GUILD_MEMBER_ADD"==c?o.emit("member_add",i):"MESSAGE_UPDATE"==c&&o.emit("edited",i)}7==n.op&&o.close(!0,!0),9==n.op&&o.close(!0),n.op},o.socket.onerror=function(e){o.socket.readyState==o.socket.CLOSED&&o.close(!0),o.emit("socketError",e.reason)},o.socket.onclose=function(e){4004!==e.code&&o.close(!0),o.emit("socketClosedError",e.reason)}},reconnecting:!1,close:function(e,t){const s=this;s.timeoutconnect&&clearTimeout(s.timeoutconnect),s.ping&&clearInterval(s.ping),s.socket.onclose=void 0,s.socket.onerror=void 0,s.socket=void 0,e&&(s.timeoutconnect=setTimeout(()=>{s.connect(t)},3e3)),s.emit("closed")},send:function(e){p.socket.send(JSON.stringify(e))}};