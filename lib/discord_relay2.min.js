const DiscTwitchRelay={chattersImgUrls:JSON.parse(sessionStorage.getItem("chattersImgUrls"))||{},settings:void 0,socket:void 0,heartbeat:5e3,session_id:void 0,seq:void 0,callbacks:{},next_callbacks:{},dms:!1,emit(e,t){void 0!==this.callbacks[e]&&this.callbacks[e].forEach((e=>{e(t)})),void 0!==this.next_callbacks[e]&&(this.next_callbacks[e].forEach((e=>{e(t)})),delete this.next_callbacks[e])},on(e,t){void 0===this.callbacks[e]&&(this.callbacks[e]=[]),this.callbacks[e].push(t)},next(e,t){void 0===this.next_callbacks[e]&&(this.next_callbacks[e]=[]),this.next_callbacks[e].push(t)},gateway:void 0,calls:{},*chunks(e,t){for(let s=0;s<e.length;s+=t)yield e.slice(s,s+t)},async fetchDiscordRelay(e,t,s){const o={method:t,headers:{"Content-Type":"application/json"}};s&&(o.body=JSON.stringify(s));const c=await fetch(e,o);let i;if(!c.ok){const e=await c.json(),t=e.message||e.error||"Something went wrong.";throw new Error(t)}try{i=await c.json()}catch(e){}return i},Chatters:async e=>{let t=JSON.parse(sessionStorage.getItem("chatters"))||[];await fetch(`https://sammi-proxy.fly.dev/https://tmi.twitch.tv/group/user/${e}/chatters`).then((e=>e.json())).then((e=>{const{broadcaster:s,moderators:o,viewers:c,vips:i}=e.chatters,n=[...o,...c,...i];if(0==n.length)return void LB.alert("Discord Relay error: Wrong channel name. No chatters found.");s[0]&&n.push(s[0]);const a=t;t=[],n.forEach((e=>{a.includes(e)||t.push(e)})),Array.prototype.unique=function(){const e=this.concat();for(let t=0;t<e.length;++t)for(let s=t+1;s<e.length;++s)e[t]===e[s]&&e.splice(s--,1);return e},sessionStorage.setItem("chatters",JSON.stringify(n.concat(a).unique()))})).catch((e=>{console.log("Discord Relay JS",e)}));[...DiscTwitchRelay.chunks(t,100)].forEach((async e=>{const t=e.join("&login=");await DiscTwitchRelay.GetProfileImages(t)})),sessionStorage.setItem("chattersImgUrls",JSON.stringify(DiscTwitchRelay.chattersImgUrls)),DiscTwitchRelay.timeout=setTimeout(DiscTwitchRelay.Chatters,6e4,e)},async GetProfileImages(e){await fetch(`https://api.twitch.tv/helix/users?login=${e}`,{headers:{"Client-ID":TWITCH_CLIENT_ID,Authorization:`Bearer ${DiscTwitchRelay.settings.oauthtoken}`,"Content-Type":"application/json"}}).then((e=>e.json())).then((e=>{e.data.forEach((e=>{const t=e.profile_image_url||e.offline_image_url;DiscTwitchRelay.chattersImgUrls[e.login]=t}))})).catch((e=>console.log(e)))},TwitchWebhook(){const{settings:e}=this;if(0!=e.array.length){const t=e.array;this.settings.array=[];let s=[],o=" ";if("Pretty"===e.mode&&t.length<11)for(let e=0;e<t.length;e++){const o=`${t[e].user_type} `||"";let c=DiscTwitchRelay.chattersImgUrls[t[e].username.toLowerCase()];c||(DiscTwitchRelay.GetProfileImages(t[e].username.toLowerCase()),c="https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png"),s.push({author:{name:o+t[e].username,url:`https://twitch.tv/${t[e].username}`,icon_url:c},description:t[e].text,color:this.convertColor(t[e].color)})}else for(let e=0;e<t.length;e++)o=`${o}_ _ \n**${t[e].username}**\n${t[e].text}`,s=void 0;const c={content:o,username:"Twitch Chat"};s&&(c.embeds=s),DiscTwitchRelay.fetchDiscordRelay(e.webhook,"POST",c).catch((e=>DiscTwitchRelay.LBAlert(`Discord Relay webhook: ${e}`)))}},convertColor(e){const t=[];let s,o;if(-1!==e.search("#")&&(e=e.substr(1)),3===e.length)for(s=e.split(""),o=0;o<3;o++)t.push(parseInt(`${s[o]}${s[o]}`,16));else if(6===e.length)for(s=e.match(/.{2}/g),o=0;o<3;o++)t.push(parseInt(s[o],16));t[2],t[1],t[0];return t[2]+(t[1]<<8)+(t[0]<<16)},async connect(e){const{settings:t}=this;let s="wss://gateway.discord.gg?v=8&encoding=json";const o=this;await fetch("https://discord.com/api/gateway","GET").then((e=>s=`${e.url}?v=8&encoding=json`)).catch((()=>{}));try{clearInterval(o.ping)}catch(e){}o.gateway=s,o.socket=new WebSocket(s),o.socket.onopen=e=>{o.emit("open","Connection established!")},o.socket.onmessage=function(s){let{data:c}=s;if("string"==typeof s.data&&(c=JSON.parse(s.data)),"READY"==c.t&&(o.emit("DiscordSuccess",s),o.session_id=c.d.session_id,o.reconnecting?(o.reconnecting=!1,o.emit("reconnected")):o.emit("ready")),null!=c.s&&(o.seq=c.s),void 0!==c.op&&10===c.op?(o.heartbeat=c.d.heartbeat_interval,o.ping=setInterval((()=>{null!=o.socket&&1===o.socket.readyState?o.socket.send(JSON.stringify({op:1,d:null})):clearInterval(o.ping)}),o.heartbeat),e?o.socket.send(JSON.stringify({op:6,d:{token:o.settings.token,session_id:o.session_id,seq:o.seq}})):o.socket.send(JSON.stringify({op:2,d:{token:t.token,intents:o.settings.dms?4608:512,large_threshold:100,properties:{os:t.os||"windows",browser:t.device||"LBTwitch",device:t.device||"LBTwitch",referrer:"",referring_domain:""}}}))):c.op,0==c.op){const e=c.t,{d:t}=c;o.emit(e,t),"MESSAGE_CREATE"===e?o.emit("message",t):"GUILD_MEMBER_REMOVE"===e?o.emit("member_remove",t):"GUILD_MEMBER_ADD"===e?o.emit("member_add",t):"MESSAGE_UPDATE"===e&&o.emit("edited",t)}7==c.op&&o.close(!0,!0),9==c.op&&o.close(!0),c.op},o.socket.onerror=e=>{o.socket.readyState==o.socket.CLOSED&&o.close(!0),o.emit("socketError",e.reason)},o.socket.onclose=e=>{4004!==e.code&&o.close(!0),o.emit("socketClosedError",e.reason)}},reconnecting:!1,close(e,t){const s=this;s.timeoutconnect&&clearTimeout(s.timeoutconnect),s.ping&&clearInterval(s.ping),s.socket.onclose=void 0,s.socket.onerror=void 0,s.socket.close(),s.socket=void 0,e&&(s.timeoutconnect=setTimeout((()=>{s.connect(t)}),3e3)),s.emit("closed")}};