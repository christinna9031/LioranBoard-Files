function TTSForLB(){const e=document.createElement("audio");e.setAttribute("id","TTSAudio"),document.body.appendChild(e),e.muted=!1;const t=[];let o=!1,n=null;LB.setVariable("speaking",!1,"TTSKStatus");const a={self:this,PollySettings(e,t){AWS.config.credentials=e,AWS.config.region=t},async GetPollyVoices(){const e=new AWS.Polly;return await e.describeVoices().promise()},GoogleSettings(e){n=e},async GetGoogleVoices(){const e=await fetch(`https://texttospeech.googleapis.com/v1beta1/voices?key=${n}`);return await e.json()},Speak(e,n,a){o||0!==t.length?t.push({type:e,msg:n,settings:a}):i(e,n,a)},SpeakNext(){if(0===t.length)return;const e=t.shift();i(e.type,e.msg,e.settings)},Skip(){e.replaceWith(e.cloneNode(!0)),e.removeEventListener("ended",s,!1),a.SpeakNext()},Play(){if(e.paused){const t=e.play();void 0!==t&&(o=!0,LB.setVariable("speaking",!0,"TTSKStatus"),e.addEventListener("ended",s,!1),t.catch(()=>{}))}},Pause(){e.replaceWith(e.cloneNode(!0));const t=e.play();void 0!==t&&t.then(t=>{e.pause(),o=!1,LB.setVariable("speaking",!1,"TTSKStatus")}).catch(()=>{})},Mute(){e.muted=!0,LB.setVariable("muted",!0,"TTSKStatus")},Unmute(){e.muted=!1,LB.setVariable("muted",!1,"TTSKStatus")},VolumeUp(){const t=e.volume+.1;e.volume=t<=1?t:1},VolumeDown(){const t=e.volume-.1;e.volume=t>=0?t:0},SetVolume(t){e.volume=t}};function s(){e.replaceWith(e.cloneNode(!0)),e.removeEventListener("ended",s,!1),o=!1,LB.setVariable("speaking",!1,"TTSKStatus"),a.SpeakNext()}async function i(e,t,a){var s,i,c;o=!0,LB.setVariable("speaking",!0,"TTSKStatus");const r=(JSON.parse(sessionStorage.getItem("TTSCached"))||[]).filter(e=>e.message.toLowerCase()==t.toLowerCase()&&JSON.stringify(e.settings)==JSON.stringify(a));let u=null===(s=r[0])||void 0===s?void 0:s.audioStream;"Polly"===e&&(u=null===(i=r[0])||void 0===i?void 0:null===(c=i.audioStream)||void 0===c?void 0:c.data),u?l(e,null,null,u):await async function(e,t,o){switch(e){default:break;case"Polly":{const e=new AWS.Polly,n="neural"!==o.pollyVoiceEngine?`pitch="${o.pitch}"`:"",a="neural"!==o.pollyVoiceEngine?"soft"==o.effect?'phonation="soft"':`name="${o.effect}"`:'name="null"',s={OutputFormat:"mp3",Text:`<speak><prosody rate="${o.speed}" ${n}><amazon:effect ${a}>${t}</amazon:effect></prosody></speak>`,VoiceId:o.pollyVoiceId||"Brian",TextType:"ssml",Engine:o.pollyVoiceEngine||"standard"};console.log(s);const i=await e.synthesizeSpeech(s).promise();if(!i.error){const e=i.AudioStream;return console.log(e),e}console.log(i),LB.alert(`TTS Polly Error: ${i.error.message}`)}break;case"Google":{const e={audioConfig:{audioEncoding:"MP3",pitch:o.pitch,speakingRate:o.speed},voice:{languageCode:o.region,name:o.voice},input:{text:t}},a=await fetch(`https://texttospeech.googleapis.com/v1beta1/text:synthesize?key=${n}`,{method:"POST",body:JSON.stringify(e)}),s=await a.json(),i=`data:audio/mp3;base64,${s.audioContent}`;return i}}}(e,t,a).then(o=>l(e,t,a,o))}function l(t,o,n,a){e.addEventListener("ended",s,!1);let i=a;if("Polly"===t){const e=new Uint8Array(a).buffer,t=new Blob([e]);i=URL.createObjectURL(t)}e.src=i;const l=e.play();if(void 0!==l&&l.then(e=>{}).catch(e=>{console.log(e),LB.alert(`TTS Error: ${e}`)}),!o)return;const c=JSON.parse(sessionStorage.getItem("TTSCached"))||[];c.push({type:t,message:o,settings:n,audioStream:a}),sessionStorage.setItem("TTSCached",JSON.stringify(c))}return a}